# Haplotype stuff

To be able to test for ABBA BABA we need to first get the snps. [Here](http://data-science-sequencing.github.io/Win2018/lectures/lecture10/) is a good explanation of SNP calling.

The basic workflow is (referenceing [this](https://sateeshperi.github.io/nextflow_varcal/nextflow/nextflow_variant_calling) website):

1. Align reads to reference sequences using BWA or bowtie
2. This will output SAM format files. You need to convert them to BAM files and sort them
4. Then, use mpileup to convert it to VCFs and call and filter the snps.
5. To do this:
   * First make a directory called snp to run the analysis in with subdirectories for Aphis and Myzus
   * Then copy the reference file from [Mathers et al ](https://zenodo.org/record/5908005#.ZC885-zMIea) to that directory.
   * Next, make a list of names you want to get variant files for: `for fq1 in ~/90day_aphid/aphis/hybpiper/APHD*_R1_A_trim.fastq.gz;  do base=$(basename $fq1 _R1_A_trim.fastq.gz);  echo "$base"; done > SampNames.txt`
   * On an interactive node, load the bwa module and make index files for the reference file: `bwa index Aphis_fabae_JIC1_v2.scaffolds.braker.filtered.cds.fa`
   * Make output directories for the results `mkdir -p sam bam bcf vcf`
   * Run sbatch on the [make_vcf](scripts/make_vcf.sh) script --first change the number for the array to the number of files in SampNames.txt.
   * This will give you output files of a bunch of vcf files.
6. However, Dsuite, asks for input of a single vcf file. To produce this, use the bam files generated by the previous step.
7. Run [mpileup.sh](scripts/mpileup.sh). This script takes in a bunch of bam files, puts them into a list, then runs bcftools mpileup on the list of bam files. Finally it puts the .pileup file into the vcf format using the bcftools call function. The output is a single .pileup file as well as a file that ends in .vcf.gz.
8. Get the stats using: `bcftools stats myzus.vcf.gz >file.stats`. It gave 4722672 records, 4699258 SNPs, and 23414 INDELS. The command was: bcftools mpileup gave "mpileup -f ../Myzus_varians_v1.1.scaffolds.braker.filtered.cds.LTPG.fa -b list.bam -q 20 -Q 30"
   * For aphis: 5438524 records, 5402431 SNPs, indels: 36093.
10. 4 and 5 million is probably more snps than we want to deal with. Let's filter based on quality and coverage. Use [coverage.sh](scripts/coverage.sh) 
    * After filtering aphis: `bcftools filter -s LowQual -e '%QUAL<50' | bedtools intersect -header -wa -a stdin -b $TARGETS` the command `bcftools stats bcf_filter.vcf.gz >filtered_file.stats` gave 552704 records with 548570 SNPS and 4134 INDELS.
    * After filtering myzus, records: 474082, SNPs: 468170, INDELS: 5912.
11. Separate the snps from the indels. On an interactive node (`salloc`), `module load vcftools`, then do `vcftools --gzvcf aphis.vcf.gz --remove-indels --recode --recode-INFO-all --out aphis_output_snps-only.vcf` and `vcftools --gzvcf aphis.vcf.gz --keep-only-indels --recode --recode-INFO-all --out aphis_output_indels-only.vcf`.
12. I'm not sure that the bedtools intersect thing worked great so we're going to do filtering again based on [this](https://bioinformaticsworkbook.org/dataAnalysis/VariantCalling/freebayes-dnaseq-workflow.html#gsc.tab=0)
```
vcf=output_snps-only.vcf.recode.vcf
vcftools --gzvcf aphis_output_snps-only.vcf.recode.vcf \
   --max-missing 1 \ # 1 indicates no missing data allowed
   --mac 3 \ # Include only sites with Minor Allele Count greater than or equal to
   --minQ 50 \ # Includes only sites with Quality value above this threshold
   --recode \
   --recode-INFO-all \
   --out aphis_output_snps-only_max_missing_1_mac_3_minq_30
```
    * After this filtering, Aphis kept 585568 SNPs and Myzus kept 1249280 SNPs.
    * To find your average quality score do `tail -n 1249281 myzus_output_snps-only_max_missing_1_mac_3_minq_50.recode.vcf | cut -f 6 | sort -n | paste -sd+ - | bc | awk '{print $1/1249281}'` (gives 835.2 for Myzus) and `tail -n 585568 aphis_output_snps-only_max_missing_1_mac_3_minq_50.recode.vcf | cut -f 6 | sort -n | paste -sd+ - | bc | awk '{print $1/585568}'` gives 1373 for Aphis.
8. Make a text file called "aphis_pop.txt" with the first column the names in aphis_genoNew and the second column the species names. `ls *final_variants.vcf | cut -c1-15 > aphis_pop.txt` then add a column with species names
9. Using the python files from [here](https://github.com/simonhmartin/tutorials/tree/master/ABBA_BABA_whole_genome), run the following `python ../genomics_general-master/freq.py -g myzus_new.geno -p ornatus -p antirhinii -p varians -p fataunae -p cerasi -p persicae --popsFile  myzus_pop.txt --target derived -o myzus75.derFreq.tsv` and for myzus do `python ../genomics_general-master/freq.py -g aphis_new.geno -p spiraecola -p craccivora -p ASPnl -p aurantii -p ruborum -p ASPnl2 -p coreopsidis -p nasturtii -p fabae -p sedi -p ASPsv -p ASPva -p nerii -p Melanaphis -p viburniphila -p affinis -p cornifoliae -p ASPlk -p Hyalopterus -p glycines -p gossypii -p urticata --popsFile  aphis_pop.txt --target derived -o aphis75.derFreq.tsv`.
10. 
Maybe we need to merge the vcf files using an actual thing. Trying with bcftools -merge. First need to pip install bgzip in a virtual environment.




