# Haplotype stuff

To be able to test for ABBA BABA we need to first get the snps. [Here](http://data-science-sequencing.github.io/Win2018/lectures/lecture10/) is a good explanation of SNP calling.

The basic workflow is (referenceing [this](https://sateeshperi.github.io/nextflow_varcal/nextflow/nextflow_variant_calling) website):

1. Align reads to reference sequences using BWA or bowtie
2. This will output SAM format files. You need to convert them to BAM files and sort them
4. Then, use mpileup to convert it to VCFs and call and filter the snps.
5. To do this:
   * First make a directory called snp to run the analysis in with subdirectories for Aphis and Myzus
   * Then copy the reference file from [Mathers et al ](https://zenodo.org/record/5908005#.ZC885-zMIea) to that directory.
   * Next, make a list of names you want to get variant files for: `for fq1 in ~/90day_aphid/aphis/hybpiper/APHD*_R1_A_trim.fastq.gz;  do base=$(basename $fq1 _R1_A_trim.fastq.gz);  echo "$base"; done > SampNames.txt`
   * On an interactive node, load the bwa module and make index files for the reference file: `bwa index Aphis_fabae_JIC1_v2.scaffolds.braker.filtered.cds.fa`
   * Make output directories for the results `mkdir -p sam bam bcf vcf`
   * Run sbatch on the [make_vcf](scripts/make_vcf.sh) script --first change the number for the array to the number of files in SampNames.txt.
   * This will give you output files of a bunch of vcf files.
   * We also need to make vcf files of the scaffolds from Mathers et al. To do this, allocate a node, load the modules for bwa, samtools and bcftools. Then, run `bwa mem ~/90day_aphid/snp/aphis/Aphis_fabae_JIC1_v2.scaffolds.braker.filtered.cds.fa ~/90day_aphid/raw_data/Frozen_release/Aphis_rumicis/v1/Aphis_rumicis_v1.scaffolds.fa | samtools sort -o bam/Aphis_rumicis_v1.aligned.bam` or run [make_vcf_mathers.sh](scripts/make_vcf_mathers.sh).
6. However, Dsuite, asks for input of a single vcf file. To produce this, use the bam files generated by the previous step.
7. Run [mpileup.sh](scripts/mpileup.sh). This script takes in a bunch of bam files, puts them into a list, then runs bcftools mpileup on the list of bam files. Finally it puts the .pileup file into the vcf format using the bcftools call function. The output is a single .pileup file as well as a file that ends in .vcf.gz.
8. Get the stats using: `bcftools stats myzus.vcf.gz >file.stats`. It gave 4722672 records, 4699258 SNPs, and 23414 INDELS. The command was: bcftools mpileup gave "mpileup -f ../Myzus_varians_v1.1.scaffolds.braker.filtered.cds.LTPG.fa -b list.bam -q 20 -Q 30"
   * For aphis: 5438524 records, 5402431 SNPs, indels: 36093.
10. 4 and 5 million is probably more snps than we want to deal with. Let's filter based on quality and coverage. Use [coverage.sh](scripts/coverage.sh) 
    * After filtering aphis: `bcftools filter -s LowQual -e '%QUAL<50' | bedtools intersect -header -wa -a stdin -b $TARGETS` the command `bcftools stats bcf_filter.vcf.gz >filtered_file.stats` gave 552704 records with 548570 SNPS and 4134 INDELS.
    * After filtering myzus, records: 474082, SNPs: 468170, INDELS: 5912.
11. Separate the snps from the indels. On an interactive node (`salloc`), `module load vcftools`, then do `vcftools --gzvcf aphis.vcf.gz --remove-indels --recode --recode-INFO-all --out aphis_output_snps-only.vcf` and `vcftools --gzvcf aphis.vcf.gz --keep-only-indels --recode --recode-INFO-all --out aphis_output_indels-only.vcf`.
12. I'm not sure that the bedtools intersect thing worked great so we're going to do filtering again based on [this](https://bioinformaticsworkbook.org/dataAnalysis/VariantCalling/freebayes-dnaseq-workflow.html#gsc.tab=0)
```
vcf=output_snps-only.vcf.recode.vcf
vcftools --gzvcf aphis_output_snps-only.vcf.recode.vcf \
   --max-missing 1 \ # 1 indicates no missing data allowed
   --mac 3 \ # Include only sites with Minor Allele Count greater than or equal to
   --minQ 50 \ # Includes only sites with Quality value above this threshold
   --recode \
   --recode-INFO-all \
   --out aphis_output_snps-only_max_missing_1_mac_3_minq_30
```
    * After this filtering, Aphis kept 585568 SNPs and Myzus kept 1249280 SNPs.
    * To find your average quality score do `tail -n 1249281 myzus_output_snps-only_max_missing_1_mac_3_minq_50.recode.vcf | cut -f 6 | sort -n | paste -sd+ - | bc | awk '{print $1/1249281}'` (gives 835.2 for Myzus) and `tail -n 585568 aphis_output_snps-only_max_missing_1_mac_3_minq_50.recode.vcf | cut -f 6 | sort -n | paste -sd+ - | bc | awk '{print $1/585568}'` gives 1373 for Aphis.
| Sample | Aphis | Aphis (including others) | Myzus | Myzus (including others) |
| --- | --- | --- | --- | --- |
|Number of samples |34 |39 |15 |19
|Number of records |5438524 |7224421 |4722672 |4954520 |
|SNPs |5402431 |7187970 |4699258 |4929427 |
|INDELS |36093 |36451 |23414 |25093 |
|Multi-allelic SNP sites |673149 |889106 |600661 |666330|
|SNPs after filtering |666330 | |666330 | |
8. Make a text file called "aphis_pop.txt" with the first column the names in aphis_genoNew and the second column the species names. `tail -n 585569 aphis_output_snps-only_max_missing_1_mac_3_minq_50.recode.vcf | head -n 1 | xargs -n 1 > aphis_pop.txt` then delete the first lines and add a tab and a column with species names. Use xxx for species that you want ignored.
9. Now after installing dsuite with:
```
$ git clone https://github.com/millanek/Dsuite.git
$ cd Dsuite
$ make
```
10. Run the [dsuite.sh](scripts/dsuite_aphis.sh) using your filtered vcf file and this pop.txt file.

### Interpreting dsuite results
Dsuite will output a file that ends in BBAA.txt and one that ends in dmin.txt.
    * Use this [r script](scripts/dsuite.R) to calculate what proportion are significant
    * Next, download these scripts plot_d.rb and plot_f4ratio.rb from [this site](https://github.com/mmatschiner/tutorials/tree/master/analysis_of_introgression_with_snp_data)
    * Then, make a text file that has the species names using `cut -f 2 myzus_pop.txt | sort | uniq > myzus_plot_order.txt` or any order you want
    * Make heatmaps using `ruby plot_d.rb myzus_pop_BBAA.txt myzus_plot_order.txt 0.7 myzus_BBAA_D.svg` and `ruby plot_f4ratio.rb myzus_pop_BBAA.txt myzus_plot_order.txt 0.2 myzus_BBAA_f4ratio.svg`
    * Next step: see if it's different when you use a tree in the analysis and figure out why the crap the heat maps aren't working for this.






